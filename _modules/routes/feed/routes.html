<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>routes.feed.routes &#8212; Aggie&#39;s House  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=def86cc0" />
    
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Aggie&#39;s House  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">routes.feed.routes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for routes.feed.routes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Endpoints used for the feed.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Like</span><span class="p">,</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Answer</span><span class="p">,</span> <span class="n">Category</span><span class="p">,</span> <span class="n">User_Photo</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">test_data</span> <span class="kn">import</span> <span class="n">age_similarity_weight</span><span class="p">,</span> <span class="n">bio_similarity_weight</span><span class="p">,</span> <span class="n">major_similarity_weight</span><span class="p">,</span> <span class="n">gender_similarity_weight</span><span class="p">,</span> <span class="n">answer_similarity_weight</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">distinct</span><span class="p">,</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># from run import s3,s3_bucket</span>

<span class="n">feed_bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;feed&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="like">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.like">[docs]</a>
<span class="nd">@feed_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/like&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">like</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to like another user.</span>

<span class="sd">    :param int liked_user_id: The ID of the user being liked.</span>

<span class="sd">    :return: Response</span>
<span class="sd">        A JSON response indicating whether the like was successful and if it resulted in a match.</span>
<span class="sd">        - message (str): A message indicating the result of the like operation.</span>
<span class="sd">        - match (bool): Indicates whether the like resulted in a match.</span>

<span class="sd">    :raises ValueError: If the request does not contain JSON data.</span>
<span class="sd">    :raises ValueError: If either the user ID or the liked user ID is missing from the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data provided&#39;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="n">liked_user_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;liked_user_id&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">liked_user_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing user ID or liked user ID&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">like</span> <span class="o">=</span> <span class="n">Like</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">liked_user_id</span><span class="o">=</span><span class="n">liked_user_id</span><span class="p">,</span> <span class="n">liked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">like</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">check_for_match</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">liked_user_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Like successful&#39;</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Like successful&#39;</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">}),</span> <span class="mi">200</span></div>

    
    
<div class="viewcode-block" id="dislike">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.dislike">[docs]</a>
<span class="nd">@feed_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/dislike&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">dislike</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to dislike another user.</span>

<span class="sd">    :param int liked_user_id: The ID of the user being disliked.</span>

<span class="sd">    :return: Response</span>
<span class="sd">        A JSON response indicating that the dislike was successful.</span>
<span class="sd">        - message (str): A message indicating the result of the dislike operation.</span>

<span class="sd">    :raises ValueError: If the request does not contain JSON data.</span>
<span class="sd">    :raises ValueError: If either the user ID or the liked user ID is missing from the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data provided&#39;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="n">liked_user_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;liked_user_id&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">liked_user_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing user ID or liked user ID&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">like</span> <span class="o">=</span> <span class="n">Like</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">liked_user_id</span><span class="o">=</span><span class="n">liked_user_id</span><span class="p">,</span> <span class="n">liked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">like</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Dilike successful&#39;</span><span class="p">}),</span> <span class="mi">200</span></div>



    

<div class="viewcode-block" id="getfeed">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.getfeed">[docs]</a>
<span class="nd">@feed_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/getfeed&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">getfeed</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to fetch the feed of potential matches for the current user.</span>

<span class="sd">    :return: Response</span>
<span class="sd">        A JSON response containing a list of user IDs representing potential matches.</span>

<span class="sd">    :raises ValueError: If the current user is not authenticated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User not authenticated&#39;</span><span class="p">}),</span> <span class="mi">401</span>
    
    <span class="n">current_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="c1">#TODO MAYBE add a limit to the number of users fetched at a time?????</span>
    <span class="c1">#get all users not liked/disliked by current user, exclude users with incomplete profiles </span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">current_user_id</span><span class="p">)</span> \
                  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                      <span class="n">Like</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user_id</span><span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">Like</span><span class="o">.</span><span class="n">liked_user_id</span><span class="p">)</span>
                  <span class="p">))</span> \
                  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">bio</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">birthday</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">major</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">first_name</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">profile_photo</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">gender</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                      <span class="n">User</span><span class="o">.</span><span class="n">deactivated</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                  <span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
        <span class="c1">#call algo function</span>
        <span class="n">user_similarities</span> <span class="o">=</span> <span class="n">compare_users_to_current</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">users</span><span class="p">)</span>

        <span class="c1">#sort based on how similar they are (descending)</span>
        <span class="n">sorted_user_similarities</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">user_similarities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">user_ids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">user_id</span> <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span><span class="n">similarity_score</span>  <span class="ow">in</span> <span class="n">sorted_user_similarities</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">}),</span> <span class="mi">200</span></div>



<div class="viewcode-block" id="unmatch">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.unmatch">[docs]</a>
<span class="nd">@feed_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/unmatch/&lt;int:matched_user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">unmatch</span><span class="p">(</span><span class="n">matched_user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to unmatch with a previously matched user.</span>

<span class="sd">    :param int matched_user_id: The ID of the user to unmatch.</span>

<span class="sd">    :return: Response</span>
<span class="sd">        A JSON response indicating whether the unmatch was successful.</span>
<span class="sd">        - message (str): A message indicating the result of the unmatch operation.</span>

<span class="sd">    :raises ValueError: If the method is not POST.</span>
<span class="sd">    :raises ValueError: If no matching entry is found for the current user and the matched user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="n">like_entry</span> <span class="o">=</span> <span class="n">Like</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user_id</span><span class="p">,</span> <span class="n">liked_user_id</span><span class="o">=</span><span class="n">matched_user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">like_entry</span><span class="p">:</span>
            <span class="n">like_entry</span><span class="o">.</span><span class="n">liked</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Unmatched successfully&#39;</span><span class="p">}),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No matching entry found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Method not allowed&#39;</span><span class="p">}),</span> <span class="mi">405</span></div>



<div class="viewcode-block" id="userinfo">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.userinfo">[docs]</a>
<span class="nd">@feed_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/userinfo&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">userinfo</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to retrieve user information.</span>

<span class="sd">    :param int user_id: The ID of the user whose information is requested.</span>

<span class="sd">    :return: Response</span>
<span class="sd">        A JSON response containing the user&#39;s information.</span>
<span class="sd">        - first_name (str): The user&#39;s first name.</span>
<span class="sd">        - age (int): The user&#39;s age.</span>
<span class="sd">        - major (str): The user&#39;s major.</span>
<span class="sd">        - bio (str): The user&#39;s biography.</span>
<span class="sd">        - categories (dict): A dictionary containing categories and their corresponding answered questions.</span>
<span class="sd">        - photos (list): A list of URLs to the user&#39;s photos.</span>
<span class="sd">        - gender (str): The user&#39;s gender.</span>
<span class="sd">        - verified (bool): Whether the user is verified.</span>
<span class="sd">        - email (str): The user&#39;s email.</span>

<span class="sd">    :raises ValueError: If no user ID is provided or if the user is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No user id provided&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
    
    <span class="n">photos</span> <span class="o">=</span> <span class="n">User_Photo</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">photo_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">photo</span><span class="o">.</span><span class="n">photo_url</span> <span class="k">for</span> <span class="n">photo</span> <span class="ow">in</span> <span class="n">photos</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">profile_photo</span><span class="p">:</span>
        <span class="n">photo_urls</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">profile_photo</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">photo_url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">photo_urls</span><span class="p">):</span>
        <span class="c1">#generate presigned link for photos in aws bucket</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FLASK_ENV&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">photo_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;aggies_house_&#39;</span><span class="p">):</span>
                <span class="n">s3_link</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">generate_presigned_url</span><span class="p">(</span>
                    <span class="s1">&#39;get_object&#39;</span><span class="p">,</span>
                    <span class="n">Params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Bucket&#39;</span><span class="p">:</span> <span class="n">s3_bucket</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="n">photo_url</span><span class="p">},</span>
                    <span class="n">ExpiresIn</span><span class="o">=</span><span class="mi">300</span>  <span class="c1"># URL expires in 1 hour</span>
                <span class="p">)</span>
                <span class="n">photo_urls</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">s3_link</span>
        
    <span class="n">user_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
            <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">calculate_age</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">birthday</span><span class="p">),</span>
            <span class="s1">&#39;major&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">major</span><span class="p">,</span>
            <span class="s1">&#39;bio&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span>
            <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;photos&#39;</span><span class="p">:</span> <span class="n">photo_urls</span><span class="p">,</span>
            <span class="s1">&#39;gender&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">gender</span><span class="p">,</span>
            <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">verified</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">verified</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="p">}</span>

    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="n">category_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">category_id</span><span class="o">=</span><span class="n">category</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
            <span class="n">answers</span> <span class="o">=</span> <span class="n">Answer</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">question_id</span><span class="o">=</span><span class="n">question</span><span class="o">.</span><span class="n">question_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">answer</span><span class="o">.</span><span class="n">answer_text</span> <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">]</span>
                <span class="n">category_data</span><span class="p">[</span><span class="n">question</span><span class="o">.</span><span class="n">question_text</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_text</span>
            <span class="k">elif</span> <span class="n">answers</span> <span class="ow">and</span> <span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">answer_text</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">category_data</span><span class="p">[</span><span class="n">question</span><span class="o">.</span><span class="n">question_text</span><span class="p">]</span> <span class="o">=</span> <span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">answer_text</span>
        <span class="c1"># Only add categories that have at least one question answered by the user</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">category_data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">][</span><span class="n">category</span><span class="o">.</span><span class="n">category_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_data</span>

    <span class="k">return</span> <span class="n">user_info</span></div>



<div class="viewcode-block" id="calculate_age">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.calculate_age">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_age</span><span class="p">(</span><span class="n">birthday</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate age based on the provided birthday.</span>

<span class="sd">    :param date birthday: The date of birth of the user.</span>

<span class="sd">    :return: int or None</span>
<span class="sd">        The calculated age of the user, or None if the birthday is not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
     
    <span class="k">if</span> <span class="n">birthday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">birthday</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="p">((</span><span class="n">today</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">birthday</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">birthday</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">age</span></div>



<div class="viewcode-block" id="check_for_match">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.check_for_match">[docs]</a>
<span class="k">def</span> <span class="nf">check_for_match</span><span class="p">(</span><span class="n">user_id_1</span><span class="p">,</span> <span class="n">user_id_2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if two users have mutually liked each other.</span>

<span class="sd">    :param int user_id_1: The ID of the first user.</span>
<span class="sd">    :param int user_id_2: The ID of the second user.</span>

<span class="sd">    :return: bool</span>
<span class="sd">        True if both users have liked each other, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">liked_1_to_2</span> <span class="o">=</span> <span class="n">Like</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id_1</span><span class="p">,</span> <span class="n">liked_user_id</span><span class="o">=</span><span class="n">user_id_2</span><span class="p">,</span> <span class="n">liked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">liked_2_to_1</span> <span class="o">=</span> <span class="n">Like</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id_2</span><span class="p">,</span> <span class="n">liked_user_id</span><span class="o">=</span><span class="n">user_id_1</span><span class="p">,</span> <span class="n">liked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    
    <span class="c1"># Check if both users liked each other</span>
    <span class="k">if</span> <span class="n">liked_1_to_2</span> <span class="ow">and</span> <span class="n">liked_2_to_1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="compare_users_to_current">
<a class="viewcode-back" href="../../../routes.feed.html#routes.feed.routes.compare_users_to_current">[docs]</a>
<span class="k">def</span> <span class="nf">compare_users_to_current</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare current user to other users based on various attributes.</span>

<span class="sd">    :param User current_user: The current user for comparison.</span>
<span class="sd">    :param list users: List of User objects to compare against.</span>
<span class="sd">    :param float age_similarity_weight: Weight for age similarity comparison.</span>
<span class="sd">    :param float bio_similarity_weight: Weight for biography similarity comparison.</span>
<span class="sd">    :param float major_similarity_weight: Weight for major similarity comparison.</span>
<span class="sd">    :param float gender_similarity_weight: Weight for gender similarity comparison.</span>
<span class="sd">    :param float answer_similarity_weight: Weight for answer similarity comparison.</span>

<span class="sd">    :return: list</span>
<span class="sd">        A list of tuples containing user IDs and their overall similarity scores compared to the current user.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="c1">#compare bios</span>
        <span class="n">tfidf_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="s1">&#39;english&#39;</span><span class="p">)</span>
        <span class="n">bios</span> <span class="o">=</span> <span class="p">[</span><span class="n">current_user</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">bio</span><span class="p">]</span>
        <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">bios</span><span class="p">)</span>
        <span class="n">bio_similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">tfidf_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">tfidf_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1">#compare age</span>
        <span class="n">age_similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">calculate_age</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">birthday</span><span class="p">)</span> <span class="o">-</span> <span class="n">calculate_age</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">birthday</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1">#compare majors - dont know if i need to do this even? simple comparison may work</span>
        <span class="n">major_similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">major</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1">#compare genders - same as above ^^ probably dont need</span>
        <span class="n">gender_similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">gender</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">gender</span> <span class="k">else</span> <span class="mi">0</span>
        

        <span class="c1">#get questions and the answers for the questions both users have answered - for only multiple choice</span>
        <span class="n">AnswerAlias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Answer</span><span class="p">)</span>

        <span class="n">common_question_answers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                                        <span class="n">Question</span><span class="o">.</span><span class="n">question_text</span><span class="p">,</span>
                                        <span class="n">Answer</span><span class="o">.</span><span class="n">answer_text</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;current_user_answer_text&#39;</span><span class="p">),</span>
                                        <span class="n">AnswerAlias</span><span class="o">.</span><span class="n">answer_text</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;other_user_answer_text&#39;</span><span class="p">),</span>
                                    <span class="p">)</span>\
                                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">question_id</span> <span class="o">==</span> <span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="p">)</span>\
                                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AnswerAlias</span><span class="p">,</span> <span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span> <span class="o">==</span> <span class="n">AnswerAlias</span><span class="o">.</span><span class="n">question_id</span><span class="p">)</span>\
                                    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
                                        <span class="n">Answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                                        <span class="n">AnswerAlias</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                                        <span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                                            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">distinct</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="p">))</span>
                                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
                                        <span class="p">),</span>
                                        <span class="n">Question</span><span class="o">.</span><span class="n">question_type</span> <span class="o">==</span> <span class="s1">&#39;multiple choice&#39;</span>
                                    <span class="p">))</span>\
                                    <span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1">#compare answers to questions</span>
        <span class="n">answer_similarities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Iterate through each question and its answers</span>
        <span class="k">for</span> <span class="n">question_text</span><span class="p">,</span> <span class="n">user1_answer</span><span class="p">,</span> <span class="n">user2_answer</span> <span class="ow">in</span> <span class="n">common_question_answers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user1_answer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user2_answer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">user1_answer</span> <span class="o">==</span> <span class="n">user2_answer</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">answer_similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>

        <span class="c1"># Filter common questions and answers for multi select questions</span>
        <span class="n">common_question_ids</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">question_text</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">question_id</span> <span class="o">==</span> <span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">question_id</span> <span class="o">==</span> <span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">question_type</span> <span class="o">==</span> <span class="s1">&#39;multi select&#39;</span><span class="p">)</span>
                            <span class="p">))</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Get each user&#39;s answeers for the multi select questions they have in common and compare the two</span>
        <span class="k">for</span> <span class="n">question_id</span><span class="p">,</span> <span class="n">question_text</span> <span class="ow">in</span> <span class="n">common_question_ids</span><span class="p">:</span>
            <span class="n">user1_answers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">answer_text</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span> <span class="o">==</span> <span class="n">question_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">user1_multi_select_answers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">answer</span> <span class="k">for</span> <span class="p">(</span><span class="n">answer</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">user1_answers</span><span class="p">])</span>

            <span class="n">user2_answers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">answer_text</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Answer</span><span class="o">.</span><span class="n">question_id</span> <span class="o">==</span> <span class="n">question_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">user2_multi_select_answers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">answer</span> <span class="k">for</span> <span class="p">(</span><span class="n">answer</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">user2_answers</span><span class="p">])</span>
            
            <span class="c1"># Calculate overlap coefficient between the two sets (size of intersection/size of smallest set)</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user1_multi_select_answers</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">user2_multi_select_answers</span><span class="p">))</span>
            <span class="n">min_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user1_multi_select_answers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">user2_multi_select_answers</span><span class="p">))</span>
            <span class="n">overlap_coefficient</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">min_size</span> <span class="k">if</span> <span class="n">min_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">answer_similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap_coefficient</span><span class="p">)</span>


        <span class="c1"># Calculate the average similarity across all answered questions</span>
        <span class="n">answer_similarity</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">answer_similarities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_similarities</span><span class="p">)</span> <span class="k">if</span> <span class="n">answer_similarities</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate overall similarity (simple mean, could add weights later on)</span>
        <span class="n">overall_similarity</span> <span class="o">=</span> <span class="n">age_similarity</span><span class="o">*</span><span class="n">age_similarity_weight</span> <span class="o">+</span>  <span class="n">bio_similarity</span><span class="o">*</span><span class="n">bio_similarity_weight</span> <span class="o">+</span>  <span class="n">major_similarity</span><span class="o">*</span><span class="n">major_similarity_weight</span> <span class="o">+</span> <span class="n">gender_similarity</span><span class="o">*</span><span class="n">gender_similarity_weight</span> <span class="o">+</span> <span class="n">answer_similarity</span><span class="o">*</span><span class="n">answer_similarity_weight</span>
        
        <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">overall_similarity</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">similarities</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Aggie&#39;s House  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">routes.feed.routes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Aggie&#39;s House Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>